<html>
<head>
	<title>Doomsday</title>
  <link rel='stylesheet' type='text/css' href='web/assets/stylesheet.css'>
  <link href="https://fonts.googleapis.com/css?family=Walter+Turncoat" rel="stylesheet"> 
</head>
<body>
	<div id="certs"></div>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="web/assets/lens.js"></script>

	<script type="text/html" id="template:cert-card-header">
		[[
			if (_.value == "") {
				_.value = "<em>(not provided)</em>"
			}
		]]
		<div class="certs-content-header">[[= _.value ]]</div>
	</script>

	<script type="text/hmtl" id="template:cert-card-line">
		[[ 
		  if (!Array.isArray(_.value)) {
				_.value = [ _.value ];
		  }
		]]
		<div class="certs-content-label">[[= _.label ]]</div>
		<div class="certs-content-value">[[= _.value[0] ]]</div>
		[[ 
		if (_.value.length > 1) {
		  _.value.slice(1).forEach(function(v) {
		]]
		    <div class="horizontal-line"></div>
			  <div class="certs-content-value">[[= v ]]</div>
		[[
		  });
		}
		]]
	</script>

	<script type="text/html" id="template:cert-card">
		<div class="cert-grid-container">
			[[
				expired = new Date().getTime()/1000 > _.cert.not_after;
				var expiredClass="";
				if (expired) { expiredClass = " expired-card"; }
			]]
			<div class="cert-card[[= expiredClass ]]" [[= (expired ? "" : 'style="background-color: rgb(' + _.color[0] + ',' + _.color[1] + ',' + _.color[2] + ');"') ]] >
			  [[ lens.include("cert-card-header", { label: "COMMON NAME", value: lens.maybe(_.cert.common_name) }); ]]
				<div class="certs-content-body">
				[[
				    timefmt = Lens.strftime("%a, %b %d %Y at %I:%M %P", _.cert.not_after );
						if (expired) {
							timefmt = "<s>"+timefmt+"</s> EXPIRED";
						}
						lens.include("cert-card-line", { label: "NOT AFTER", value: timefmt });
						lens.include("cert-card-line", { label: "PATHS", value: _.cert.paths.map(function(path) { return path.backend + ":" + path.location })});
				]]
					</div>
			</div>
		</div>
	</script>

	<script type="text/html" id="template:cert-list">
		  <div class="cert-list">
				<div class="cert-list-body">
				[[
					if (_.cutoff != _.previous_cutoff) {
						color_divisor = _.cutoff - _.previous_cutoff;
						red_range = _.color[0] - _.previous_color[0];
						green_range = _.color[1] - _.previous_color[1];
						blue_range = _.color[2] - _.previous_color[2];
					} 

					_.certs.forEach(function(v) {
						var color = _.color;
						if (_.cutoff != _.previous_cutoff) {
							var color_dividend = v.not_after - _.previous_cutoff;
							var color_percent = color_dividend / color_divisor;
							var red = _.previous_color[0] + (red_range * color_percent);
							var green = _.previous_color[1] + (green_range * color_percent);
							var blue = _.previous_color[2] + (blue_range * color_percent);
							color = [red, green, blue];
						}

						lens.include("cert-card", { cert: v, color: color });
					}); 
				]]
				</div>
				<div class="cert-list-header-line-taper-in"></div>
				<div class="cert-list-header-line"></div>
				<div class="cert-list-header-container">
					<div class="cert-list-header" style="background-color: rgb([[= _.color[0] + ',' + _.color[1] + ',' + _.color[2] ]]);">
						[[= _.header ]]
					</div>
				</div>
				[[ if (!_.skip_lower_line) { ]]
					<div class="cert-list-header-line"></div>
					<div class="cert-list-header-line-taper-out"></div>
				[[ } ]]
			</div>
	</script>

	<script type="text/html" id="template:cert-list-group">
		[[
			_.lists.forEach(function(v, i) {
			  if (i == _.lists.length - 1) {
					v.skip_lower_line = true;
				}

				lens.include("cert-list", v);
			});
		]]
	</script>

	<script>
		function updateCertList() {
			$.ajax({
				method: "GET",
				url: "/v1/cache",
				dataType: "json",
				success: function(data) {
					now = new Date().getTime()/1000;
					var sections = [
						{label: "NOW",       cutoff: 0,     color: [229, 53, 69]},
						{label: "1 WEEK",    cutoff: 7,     color: [253, 126, 20]},
						{label: "2 WEEKS",   cutoff: 14,    color: [255, 193, 7]},
						{label: "3 WEEKS",   cutoff: 21,    color: [200, 185, 15]},
						{label: "1 MONTH",   cutoff: 30,    color: [40, 167, 69]},
						{label: "2 MONTHS",  cutoff: 60,    color: [40, 167, 69]},
						{label: "3 MONTHS",  cutoff: 90,    color: [40, 167, 69]},
						{label: "6 MONTHS",  cutoff: 180,   color: [40, 167, 69]},
						{label: "1 YEAR",    cutoff: 365,   color: [40, 167, 69]},
						{label: "2 YEARS",   cutoff: 730,   color: [40, 167, 69]},
						{label: "5 YEARS",   cutoff: 1461,  color: [40, 167, 69]},
						{label: "10 YEARS",  cutoff: 2922,  color: [40, 167, 69]},
						{label: "20 YEARS",  cutoff: 5844,  color: [40, 167, 69]},
						{label: "50 YEARS",  cutoff: 14610, color: [40, 167, 69]},
						{label: "100 YEARS", cutoff: 29220, color: [40, 167, 69]}
					]

					var lists = []
					
					var i = 0;
					sections.forEach(function(section, j) {
						startIdx = i;
						cutoffTime = now + (60 * 60 * 24 * section.cutoff);
						for (; i < data.content.length; i++) {
							if (cutoffTime <= data.content[i].not_after) {
								break;
							}
						}

						lists.push({
							header: section.label, 
							previous_cutoff: (j > 0 ? now + sections[j-1].cutoff * 60 * 60 * 24 : 0),
							cutoff: cutoffTime,
							previous_color: (j > 0 ? sections[j-1].color : section.color),
							color: section.color, 
							certs: data.content.slice(startIdx, i)
						});
					});

					lists.push({header: "A LONG TIME FROM NOW...", cutoff: 0, previous_cutoff: 0, color: "#28a745", certs: data.content.slice(i)});

					$("#certs").template("cert-list-group", {lists: lists});
					$("#certs").show();
				}
			})
		}
		$(document).ready(function(){
			updateCertList();
			setInterval(updateCertList, 60 * 1000);
		});
	</script>
</body>
</html>
